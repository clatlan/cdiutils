# GitLab CI for CDIutils using ESRF pyci templates

include:
  - project: dau/ci/pyci
    file: .gitlab-ci-template.yml

variables:
  # disable coverage for faster testing (re-enable with PYTEST_COV: "--cov=./src")
  PYTEST_COV: ""
  # run pytest on tests/ directory (default is ".")
  PYTEST_DIR: "tests"
  # additional pytest options
  PYTEST_OPTIONS: "-v -ra --tb=short"

# lint job (ruff formatting and linting)
lint:
  stage: style
  extends: .style
  script:
    - pip install ruff
    - ruff check src/cdiutils tests
    - ruff format --check --line-length 79 src/cdiutils tests

# test on Python 3.10
test-3.10:
  extends: .test-3.10
  rules:
    - if: "$CI_MERGE_REQUEST_ID"  # Run on merge requests
    - if: "$CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH"  # Run on main branch

# test on Python 3.11
test-3.11:
  extends: .test-3.11
  rules:
    - if: "$CI_MERGE_REQUEST_ID"
    - if: "$CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH"

# test on Python 3.12
test-3.12:
  extends: .test-3.12
  rules:
    - if: "$CI_MERGE_REQUEST_ID"
    - if: "$CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH"

# build source distribution (.tar.gz)
# runs on main branch only to avoid wasting resources
build_sdist:
  extends: .build_sdist

# test the sdist on Python 3.10
test_sdist-3.10:
  extends: .test_sdist-3.10

# test the sdist on Python 3.11
test_sdist-3.11:
  extends: .test_sdist-3.11

# test the sdist on Python 3.12
test_sdist-3.12:
  extends: .test_sdist-3.12

# create release assets (sdist attached to GitLab releases)
assets:
  extends: .assets

# NOTE: Documentation is built by Read the Docs, not GitLab CI
# The following jobs are commented out because we use Read the Docs:
# build_doc:
#   extends: .build_doc
# pages:
#   extends: .pages

# deploy to PyPI (manual, protected tags only)
# uncomment when ready to deploy
# pypi:
#   extends: .pypi

# deploy to Test PyPI (manual)
# testpypi:
#   extends: .testpypi
