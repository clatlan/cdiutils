# GitLab CI for CDIutils using shell executor with mamba
# based on PyNX CI template

stages:
  - build
  - test
  - cleanup

# run CI for merge requests and pushes to dev/master
.default_rules:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "dev"
    - if: $CI_COMMIT_BRANCH == "master"

variables:
  # path to conda environment
  CDIUTILS_ENV: $CI_BUILDS_DIR/cdiutils/$CI_PIPELINE_ID/cdiutils_env
  CDIUTILS_TEST_DATA: /scisoft/cdiutils_test_data

build-job:
  stage: build
  tags:
    - gpu
  rules:
    - !reference [.default_rules, rules]
  script:
    - echo "building cdiutils environment..."
    - echo "pipeline ID:" $CI_PIPELINE_ID
    - echo "project dir:" $CI_PROJECT_DIR
    - echo "builds dir:" $CI_BUILDS_DIR
    # clean up any existing environment
    - rm -rf $CI_BUILDS_DIR/cdiutils/$CI_PIPELINE_ID
    - mkdir -p $CI_BUILDS_DIR/cdiutils/$CI_PIPELINE_ID
    # load mamba module
    - module load mamba
    - which mamba
    # create environment from environment-dev.yml
    - mamba env create --prefix $CDIUTILS_ENV --file $CI_PROJECT_DIR/environment-dev.yml
    - mamba activate $CDIUTILS_ENV
    - python --version
    # install cdiutils in editable mode
    - pip install -e $CI_PROJECT_DIR
    - echo "environment created successfully"

lint-job:
  stage: test
  tags:
    - gpu
  rules:
    - !reference [.default_rules, rules]
  script:
    - echo "running ruff linting..."
    - module load mamba
    - mamba activate $CDIUTILS_ENV
    - ruff check src/cdiutils tests
    - ruff format --check --line-length 79 src/cdiutils tests
    - echo "linting passed"

test-unit:
  stage: test
  tags:
    - gpu
  rules:
    - !reference [.default_rules, rules]
  script:
    - echo "running unit tests..."
    - module load mamba
    - mamba activate $CDIUTILS_ENV
    - pytest tests/unit -v -ra --tb=short
    - echo "unit tests passed"

test-integration:
  stage: test
  tags:
    - gpu
  rules:
    - !reference [.default_rules, rules]
  script:
    - echo "running integration tests (no GPU)..."
    - module load mamba
    - mamba activate $CDIUTILS_ENV
    - pytest tests/integration -m "integration and not gpu" -v -ra --tb=short
    - echo "integration tests passed"
  timeout: 30 minutes
  allow_failure: true

test-gpu:
  stage: test
  tags:
    - gpu
  rules:
    - !reference [.default_rules, rules]
  script:
    - echo "running GPU tests..."
    - module load mamba cuda
    - which nvcc
    - nvcc --version
    - mamba activate $CDIUTILS_ENV
    - echo "Setting PyNX bin directory..."
    - export PYNX_BIN="/cvmfs/hpc.esrf.fr/software/packages/ubuntu24.04/x86_64/pynx/2025.1/bin"
    - echo "Running GPU pipeline test..."
    - pytest tests/integration/test_pipeline_full.py::TestFullPipelineID01::test_full_pipeline_real_data -v -ra --tb=short
    - echo "GPU pipeline test passed"
  artifacts:
    paths:
      - gpu_test_results/
    expire_in: 1 day
  timeout: 30 minutes
  allow_failure: true

test-postprocessing:
  stage: test
  tags:
    - gpu
  dependencies:
    - test-gpu
  rules:
    - !reference [.default_rules, rules]
  script:
    - echo "running postprocessing tests with GPU results..."
    - module load mamba
    - mamba activate $CDIUTILS_ENV
    - echo "Checking for GPU test artifacts..."
    - ls -la gpu_test_results/ || echo "No artifacts found"
    - echo "Running postprocessing tests..."
    - pytest tests/integration/test_pipeline_postprocessing.py::TestPostprocessingWithRealData -v -ra --tb=short
    - echo "Postprocessing tests passed"
  timeout: 15 minutes
  allow_failure: true

# always cleanup environment at the end
cleanup-job:
  stage: cleanup
  tags:
    - gpu
  rules:
    - !reference [.default_rules, rules]
  script:
    - echo "cleaning up environment..."
    - rm -rf $CI_BUILDS_DIR/cdiutils/$CI_PIPELINE_ID
    - rmdir --ignore-fail-on-non-empty $CI_BUILDS_DIR/cdiutils
    - echo "cleanup complete"
  when: always
