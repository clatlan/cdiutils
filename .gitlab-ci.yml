# Simplified GitLab CI for CDIutils
# Based on your actual needs - no unnecessary complexity!

stages:
  - lint
  - test

# Cache pip packages to speed up builds
cache:
  paths:
    - .cache/pip

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

# Check code quality
lint:
  stage: lint
  script:
    - export PATH="$HOME/.local/bin:$PATH"
    - pip install --user ruff
    - ruff check src/cdiutils tests
    - ruff format --check --line-length 79 src/cdiutils tests

# Run unit tests
test-unit:
  stage: test
  script:
    - pip install -e .
    - pip install pytest
    - pytest tests/unit -v

# Run integration tests (no GPU)
# Manual trigger - run when you have test data ready
test-integration:
  stage: test
  when: manual
  script:
    - pip install -e .
    - pip install pytest pytest-timeout
    - |
      if [ -d "/scisoft/cdiutils_test_data" ]; then
        ln -s /scisoft/cdiutils_test_data tests/raw_data
      fi
    - pytest tests/integration -m "integration and not gpu" -v --timeout=600
  timeout: 30 minutes
  allow_failure: true
  artifacts:
    when: always
    paths:
      - tests/results/
    expire_in: 1 week

# Optional: Test on multiple Python versions
# Uncomment when needed
# test-python-versions:
#   stage: test
#   when: manual
#   image: python:${PYTHON_VERSION}
#   parallel:
#     matrix:
#       - PYTHON_VERSION: ['3.10', '3.11', '3.12']
#   script:
#     - pip install -e .
#     - pip install pytest
#     - pytest tests/unit -v
