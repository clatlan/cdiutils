# simplified GitLab CI for CDIutils

stages:
  - lint
  - test

# cache pip packages to speed up builds
cache:
  paths:
    - .cache/pip

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

# common setup - upgrade pip before installing
before_script:
  - export PATH="$HOME/.local/bin:$PATH"

# check code quality
lint:
  stage: lint
  script:
    - pip install --user ruff
    - ruff check src/cdiutils tests
    - ruff format --check --line-length 79 src/cdiutils tests

# run unit tests
test-unit:
  stage: test
  script:
    - pip install --user --upgrade pip setuptools wheel
    - pip install --user -e .
    - pip install --user pytest
    - pytest tests/unit -v

# run integration tests (no GPU)
# manual trigger - run when you have test data ready
test-integration:
  stage: test
  when: manual
  script:
    - pip install --user --upgrade pip setuptools wheel
    - pip install --user -e .
    - pip install --user pytest pytest-timeout
    - |
      if [ -d "/scisoft/cdiutils_test_data" ]; then
        ln -s /scisoft/cdiutils_test_data tests/raw_data
      fi
    - pytest tests/integration -m "integration and not gpu" -v --timeout=600
  timeout: 30 minutes
  allow_failure: true
  artifacts:
    when: always
    paths:
      - tests/results/
    expire_in: 1 week

# optional: test on multiple python versions
# test-python-versions:
#   stage: test
#   when: manual
#   image: python:${PYTHON_VERSION}
#   parallel:
#     matrix:
#       - PYTHON_VERSION: ['3.10', '3.11', '3.12']
#   script:
#     - pip install -e .
#     - pip install pytest
#     - pytest tests/unit -v
