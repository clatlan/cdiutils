# GitLab CI for CDIutils using shell executor with mamba
# based on PyNX CI template

stages:
  - build
  - test
  - cleanup

# run CI for merge requests and pushes to dev/master
.default_rules:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "dev"
    - if: $CI_COMMIT_BRANCH == "master"

variables:
  # path to conda environment
  CDIUTILS_ENV: $CI_BUILDS_DIR/cdiutils/$CI_PIPELINE_ID/cdiutils_env

build-job:
  stage: build
  rules:
    - !reference [.default_rules, rules]
  script:
    - echo "building cdiutils environment..."
    - echo "pipeline ID:" $CI_PIPELINE_ID
    - echo "project dir:" $CI_PROJECT_DIR
    - echo "builds dir:" $CI_BUILDS_DIR
    # clean up any existing environment
    - rm -rf $CI_BUILDS_DIR/cdiutils/$CI_PIPELINE_ID
    - mkdir -p $CI_BUILDS_DIR/cdiutils/$CI_PIPELINE_ID
    # load mamba module
    - module load mamba
    - which mamba
    # create environment from environment-dev.yml with Python 3.12
    - mamba env create --prefix $CDIUTILS_ENV --file $CI_PROJECT_DIR/environment-dev.yml python=3.12
    - conda activate $CDIUTILS_ENV
    - python --version
    # install cdiutils in editable mode
    - pip install -e $CI_PROJECT_DIR
    - echo "environment created successfully"

lint-job:
  stage: test
  rules:
    - !reference [.default_rules, rules]
  script:
    - echo "running ruff linting..."
    - module load mamba
    - conda activate $CDIUTILS_ENV
    - ruff check src/cdiutils tests
    - ruff format --check --line-length 79 src/cdiutils tests
    - echo "linting passed"

test-unit:
  stage: test
  rules:
    - !reference [.default_rules, rules]
  script:
    - echo "running unit tests..."
    - module load mamba
    - conda activate $CDIUTILS_ENV
    - pytest tests/unit -v -ra --tb=short
    - echo "unit tests passed"

test-integration:
  stage: test
  rules:
    - !reference [.default_rules, rules]
  script:
    - echo "running integration tests (no GPU)..."
    - module load mamba
    - conda activate $CDIUTILS_ENV
    - pytest tests/integration -m "integration and not gpu" -v -ra --tb=short --timeout=600
    - echo "integration tests passed"
  timeout: 30 minutes
  allow_failure: true

test-gpu:
  stage: test
  rules:
    - !reference [.default_rules, rules]
  script:
    - echo "running GPU tests..."
    - module load mamba cuda
    - which nvcc
    - nvcc --version
    - conda activate $CDIUTILS_ENV
    - pytest tests/integration -m gpu -v -ra --tb=short --timeout=600
    - echo "GPU tests passed"
  timeout: 30 minutes
  allow_failure: true

# always cleanup environment at the end
cleanup-job:
  stage: cleanup
  rules:
    - !reference [.default_rules, rules]
  script:
    - echo "cleaning up environment..."
    - rm -rf $CI_BUILDS_DIR/cdiutils/$CI_PIPELINE_ID
    - rmdir --ignore-fail-on-non-empty $CI_BUILDS_DIR/cdiutils
    - echo "cleanup complete"
  when: always
